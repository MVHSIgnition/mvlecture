<!DOCTYPE html>
<html>
<head>
	<style>
	.h1{
	  text-align: center;
	}
	.button {
	  display: inline-block;
	  border-radius: 4px;
	  background-color: #008080;
	  border: none;
	  color: #FFFFFF;
	  text-align: center;
	  font-size: 28px;
	  /*padding: 20px;*/
	  width: 48.4%;
	  height: 100px;
	  transition: all 0.5s;
	  cursor: pointer;
	  margin: 5px;
	}

	.button span {
	  cursor: pointer;
	  display: inline-block;
	  position: relative;
	  transition: 0.5s;
	}

	.button span:after {
	  content: '\00bb';
	  position: absolute;
	  opacity: 0;
	  top: 0;
	  right: -20px;
	  transition: 0.5s;
	}

	.button:hover span {
	  padding-right: 25px;
	}

	.button:hover span:after {
	  opacity: 1;
	  right: 0;
	}
	.button1 {
	  display: inline-block;
	  border-radius: 4px;
	  background-color: #008080;
	  border: none;
	  color: #FFFFFF;
	  text-align: center;
	  font-size: 28px;
	  padding: 20px;
	  width: 97.7%;
	  height: 100px;
	  transition: all 0.5s;
	  cursor: pointer;
	  margin: 5px;
	}

	.button1 span {
	  cursor: pointer;
	  display: inline-block;
	  position: relative;
	  transition: 0.5s;
	}

	.button1 span:after {
	  content: '\00bb';
	  position: absolute;
	  opacity: 0;
	  top: 0;
	  right: -20px;
	  transition: 0.5s;
	}

	.button1:hover span {
	  padding-right: 25px;
	}

	.button1:hover span:after {
	  opacity: 1;
	  right: 0;
	}
	</style>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Livestream Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <h1 class = "h1">Livestream Controller</h1>
    <button class = "button1" onclick="startEndStream()" style="vertical-align:middle"><span>Start Stream</span></button>
    <button class = "button1" onclick="updateYoutubeDescription()" style="vertical-align:middle"><span>Update Youtube Description</span></button>
        <button class = "button" onclick="markTimestamp()" style="vertical-align:middle"><span>Bookmark</span></button>
    <button class = "button" onclick="clearBookmarks()" style="vertical-align:middle"><span>Clear Bookmarks</span></button>
    <p id="error" style="color:red"></p>
    <p id="success" style="color:green"></p>

    <h3>Bookmarks</h3>
    <ul id="bookmarks">
    </ul>

    <script>

        // Create timestamps array based on cookie
        var timestampsCookie = getCookie('timestamps'); 
        var timestamps = timestampsCookie ? timestampsCookie.split(',') : [];
        updateBookmarksList();

        // Get url hash contents
        var json_str_escaped = window.location.hash.slice(1);
        var params = JSON.parse('{"' + decodeURI(json_str_escaped).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');
        
        // Validate token, print error if not valid
        if (!params.error) {
            document.getElementById('error').innerHTML = '';
            fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + params.access_token)
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.log('Error: ', data.error);
                        document.getElementById('error').innerHTML = 'Error: ' + data.error;
                    }
                })
                .catch(error => {
                    console.log(error);
                });
        } else {
            console.log('Error: ', params.error);
        }

        var broadcastData = {};
        
        function markTimestamp() {
            document.getElementById('error').innerHTML = '';
            fetch('https://www.googleapis.com/youtube/v3/liveBroadcasts?part=id,snippet&mine=true&maxResults=1', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + params.access_token
                }
            }).then(response => {
                return response.json();
            }).then(data => {
                console.log(data);
                broadcastData = data;
                
                if (!data.items[0].snippet.actualEndTime && data.items[0].snippet.actualStartTime) {
                    var startDate = new Date(data.items[0].snippet.actualStartTime);
                    var curDate = new Date();
                    
                    var msDif = curDate.getTime() - startDate.getTime();
                    var timestamp = getTimestamp(msDif);
                    
                    console.log(timestamp);
                    addToBookmarksList(timestamp);
                    timestamps.push(timestamp);
                    document.cookie = 'timestamps=' + timestamps;
                } else {
                    document.getElementById('error').innerHTML = 'Error: User is not currently livestreaming.';
                    console.log('Error: User is not currently livestreaming.');
                }
            }).catch(error => {
                console.log(error);
            });
        }

        function updateYoutubeDescription() {
            document.getElementById('error').innerHTML = '';
            document.getElementById('success').innerHTML = '';

            console.log('broadcastData: ', broadcastData);
            var timestampsString = '';
            for (var i = 0; i < timestamps.length; i++) {
                timestampsString += timestamps[i] + '\n';
            }
            timestampsString += 'Made possible by the MVHS Ignition Club';
            console.log(timestampsString);

            var data = {
                id: broadcastData.items[0].id,
                snippet: {
                    description: timestampsString,
                    title: broadcastData.items[0].snippet.title,
                    scheduledStartTime: broadcastData.items[0].snippet.scheduledStartTime,
                }
            };

            fetch('https://www.googleapis.com/youtube/v3/liveBroadcasts?part=id,snippet', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + params.access_token,
                },
                body: JSON.stringify(data),
            }).then(response => {
                return response.json();
            }).then(data => {
                console.log(data);
                if (data.error) {
                    console.log(data.error);
                    document.getElementById('error').innerHTML = 'An error occured when trying to update Youtube description';
                } else {
                    document.getElementById('success').innerHTML = 'Successfully updated Youtube description';
                }
            }).catch(error => {
                console.log(error);
            });
        }

        function startEndStream() {
            // Start stream
            var insertLiveStreamData = {
                "snippet": {
                    "title": "Teacher LiveStream"
                },
                "cdn": {
                    "resolution": "720p",
                    "frameRate": "30fps",
                    "ingestionType": "rtmp"
                }
            };

            fetch('https://www.googleapis.com/youtube/v3/liveStreams?part=id,snippet,cdn', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + params.access_token,
                },
                body: JSON.stringify(insertLiveStreamData),
            }).then(response => {
                return response.json()
            }).then(data => {
                console.log(data);
            }).catch(error => {
                console.log(error);
            });
            
            fetch('../start_streaming', {
                method: 'POST',
                body: ''
            });
        }

        function clearBookmarks() {
            document.cookie = 'timestamps=';
            timestamps = [];
            updateBookmarksList();
        }

        function updateBookmarksList() {
            document.getElementById('bookmarks').innerHTML = '';
            for (var i = 0; i < timestamps.length; i++) {
                document.getElementById('bookmarks').insertAdjacentHTML('beforeend', '<li>' + timestamps[i] + '</li>');
            }
        }

        function addToBookmarksList(timestamp) {
            document.getElementById('bookmarks').insertAdjacentHTML('beforeend', '<li>' + timestamp + '</li>');
        }

        function getTimestamp(ms) {
            if (ms > 0) {
                var s, m, h;
                s = Math.floor(ms / 1000);
                m = Math.floor(s / 60);
                h = Math.floor(m / 60);
                s %= 60;
                m %= 60;

                var fmt = '';
                if (Math.floor(h / 10) == 0)
                    fmt += '0';
                fmt += h + ':';
                if (Math.floor(m / 10) == 0)
                    fmt += '0';
                fmt += m + ':';
                if (Math.floor(s / 10) == 0)
                    fmt += '0';
                fmt += s;
                
                return fmt;
            } else {
                return '00:00:00';
            }
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

    </script>
</body>
</html>