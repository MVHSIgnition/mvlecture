<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Livestream Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <h1>Livestream Controller</h1>
    <button onclick="markTimestamp()">Bookmark</button>
    <button onclick="clearBookmarks()">Clear Bookmarks</button>
    <button onclick="updateYoutubeDescription()">Update Youtube Description</button>
    <p id="error" style="color:red"></p>
    <p id="success" style="color:green"></p>

    <div id="video-container"></div>
    <div id="image-container"></div>

    <h3>Bookmarks</h3>
    <ul id="bookmarks">
    </ul>

    <script src="js/ffmpeg-mp4.js"></script>
    <script type="text/javascript" src="http://www.dynamsoft.com/library/dcs/dynamsoft.camera.min.js"> </script>
    <script>
        var dcsObject, imageViewer;

        var width = 480, height = 320;

        function onInitSuccess(videoViewerId, imageViewerId) {
            dcsObject = dynamsoft.dcsEnv.getObject(videoViewerId); // Get the Dynamsoft Webcam object
            dcsObject.videoviewer.setWidth(width);
            dcsObject.videoviewer.setHeight(height);
            imageViewer = dcsObject.getImageViewer(imageViewerId); // Get a specific image viewer
            imageViewer.ui.setWidth(width);
            imageViewer.ui.setHeight(height);
        }

        function onInitFailure(errorCode, errorString) {
            alert('Init failed: ' + errorString);
        };
        dynamsoft.dcsEnv.init('video-container', 'image-container', onInitSuccess, onInitFailure);

        var cameraList = dcsObject.camera.getCameraList();
        console.log(cameraList);
        
        var stdout = '';
        var stderr = '';

        if (navigator.mediaDevices.getUserMedia) {       
            navigator.mediaDevices.getUserMedia({video: true})
              .then(function(stream) {
                console.log(stream);
                var video = document.querySelector("#videoElement");
                video.srcObject = stream;
                var url = URL.createObjectURL(stream);
                console.log('thing: ', url);
                var result = ffmpeg({
                    MEMFS: [{name: 'test.webm', data: video.src}],
                    arguments: ["-i", "test.webm", "-c:v", "libvpx", "-an", "out.webm"],
                    print: function(data) { stdout += data + "\n"; },
                    printErr: function(data) { stderr += data + "\n"; },
                    onExit: function(code) {
                        console.log("Process exited with code " + code);
                        console.log(stderr);
                        console.log(stdout);
                    },
                });
                var out = result.MEMFS[0];
                console.log('out: ', out);
              })
              .catch(function(err0r) {
                console.log(err0r);
                console.log("Something went wrong!");
              });
        }

        // Create timestamps array based on cookie
        var timestampsCookie = getCookie('timestamps'); 
        var timestamps = timestampsCookie ? timestampsCookie.split(',') : [];
        updateBookmarksList();

        // Get url hash contents
        var json_str_escaped = window.location.hash.slice(1);
        var params = JSON.parse('{"' + decodeURI(json_str_escaped).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');
        
        // Validate token, print error if not valid
        if (!params.error) {
            document.getElementById('error').innerHTML = '';
            fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + params.access_token)
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.log('Error: ', data.error);
                        document.getElementById('error').innerHTML = 'Error: ' + data.error;
                    }
                })
                .catch(error => {
                    console.log(error);
                });
        } else {
            console.log('Error: ', params.error);
        }

        var broadcastData = {};
        
        function markTimestamp() {
            document.getElementById('error').innerHTML = '';
            fetch('https://www.googleapis.com/youtube/v3/liveBroadcasts?part=id,snippet&mine=true&maxResults=1', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + params.access_token
                }
            }).then(response => {
                return response.json();
            }).then(data => {
                console.log(data);
                broadcastData = data;
                
                if (!data.items[0].snippet.actualEndTime && data.items[0].snippet.actualStartTime) {
                    var startDate = new Date(data.items[0].snippet.actualStartTime);
                    var curDate = new Date();
                    
                    var msDif = curDate.getTime() - startDate.getTime();
                    var timestamp = getTimestamp(msDif);
                    
                    console.log(timestamp);
                    addToBookmarksList(timestamp);
                    timestamps.push(timestamp);
                    document.cookie = 'timestamps=' + timestamps;
                } else {
                    document.getElementById('error').innerHTML = 'Error: User is not currently livestreaming.';
                    console.log('Error: User is not currently livestreaming.');
                }
            }).catch(error => {
                console.log(error);
            });
        }

        function updateYoutubeDescription() {
            document.getElementById('error').innerHTML = '';
            document.getElementById('success').innerHTML = '';

            console.log('broadcastData: ', broadcastData);
            var timestampsString = '';
            for (var i = 0; i < timestamps.length; i++) {
                timestampsString += timestamps[i] + '\n';
            }
            timestampsString += 'Made possible by the MVHS Ignition Club';
            console.log(timestampsString);

            var data = {
                id: broadcastData.items[0].id,
                snippet: {
                    description: timestampsString,
                    title: broadcastData.items[0].snippet.title,
                    scheduledStartTime: broadcastData.items[0].snippet.scheduledStartTime,
                }
            };

            fetch('https://www.googleapis.com/youtube/v3/liveBroadcasts?part=id,snippet', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + params.access_token,
                },
                body: JSON.stringify(data),
            }).then(response => {
                return response.json();
            }).then(data => {
                console.log(data);
                if (data.error) {
                    console.log(data.error);
                    document.getElementById('error').innerHTML = 'An error occured when trying to update Youtube description';
                } else {
                    document.getElementById('success').innerHTML = 'Successfully updated Youtube description';
                }
            }).catch(error => {
                console.log(error);
            });
        }

        function clearBookmarks() {
            document.cookie = 'timestamps=';
            timestamps = [];
            updateBookmarksList();
        }

        function updateBookmarksList() {
            document.getElementById('bookmarks').innerHTML = '';
            for (var i = 0; i < timestamps.length; i++) {
                document.getElementById('bookmarks').insertAdjacentHTML('beforeend', '<li>' + timestamps[i] + '</li>');
            }
        }

        function addToBookmarksList(timestamp) {
            document.getElementById('bookmarks').insertAdjacentHTML('beforeend', '<li>' + timestamp + '</li>');
        }

        function getTimestamp(ms) {
            if (ms > 0) {
                var s, m, h;
                s = Math.floor(ms / 1000);
                m = Math.floor(s / 60);
                h = Math.floor(m / 60);
                s %= 60;
                m %= 60;

                var fmt = '';
                if (Math.floor(h / 10) == 0)
                    fmt += '0';
                fmt += h + ':';
                if (Math.floor(m / 10) == 0)
                    fmt += '0';
                fmt += m + ':';
                if (Math.floor(s / 10) == 0)
                    fmt += '0';
                fmt += s;
                
                return fmt;
            } else {
                return '00:00:00';
            }
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

    </script>
</body>
</html>